<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Summary | Ngaoyi Cleaning</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .notification { position: fixed; top: 20px; right: 20px; z-index: 50; transition: all 0.3s ease; }
        .spinner { border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid #fff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

    <div id="notification-container" class="notification"></div>

    <header class="sticky top-0 bg-white shadow-sm z-40">
        <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-900 text-white rounded-full flex items-center justify-center font-bold">NC</div>
                <div>
                    <h1 class="text-xl font-bold text-blue-900">Ngaoyi Cleaning</h1>
                    <p class="text-xs text-gray-500">Professional Services</p>
                </div>
            </div>
            <a href="booking.html" class="text-sm text-blue-900 bg-blue-50 px-4 py-2 rounded-lg hover:bg-blue-100 transition">
                <i class="fas fa-arrow-left mr-2"></i> Back
            </a>
        </nav>
    </header>

    <main class="py-10 container mx-auto px-4 max-w-5xl">
        <h1 class="text-3xl font-bold text-blue-900 mb-2">Review Booking</h1>
        <p class="text-gray-500 mb-8">Please check your details before secure payment.</p>

        <div class="grid md:grid-cols-3 gap-8">
            <div class="md:col-span-2 space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h2 class="text-lg font-bold border-b pb-3 mb-4 flex items-center gap-2"><i class="fas fa-user text-blue-600"></i> Customer</h2>
                    <div class="grid sm:grid-cols-2 gap-4 text-sm">
                        <div><p class="text-gray-400 text-xs uppercase">Name</p><p id="sum-name" class="font-medium">Loading...</p></div>
                        <div><p class="text-gray-400 text-xs uppercase">Email</p><p id="sum-email" class="font-medium">Loading...</p></div>
                        <div><p class="text-gray-400 text-xs uppercase">Phone</p><p id="sum-phone" class="font-medium">Loading...</p></div>
                        <div><p class="text-gray-400 text-xs uppercase">Address</p><p id="sum-address" class="font-medium">Loading...</p></div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h2 class="text-lg font-bold border-b pb-3 mb-4 flex items-center gap-2"><i class="fas fa-broom text-blue-600"></i> Service</h2>
                    <div class="grid sm:grid-cols-2 gap-4 text-sm">
                        <div><p class="text-gray-400 text-xs uppercase">Service Type</p><p id="sum-service" class="font-medium">Loading...</p></div>
                        <div><p class="text-gray-400 text-xs uppercase">Property Size</p><p id="sum-size" class="font-medium">Loading...</p></div>
                        <div><p class="text-gray-400 text-xs uppercase">Date</p><p id="sum-date" class="font-medium">Loading...</p></div>
                        <div><p class="text-gray-400 text-xs uppercase">Materials</p><p id="sum-mat" class="font-medium">Loading...</p></div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h2 class="text-lg font-bold border-b pb-3 mb-4">Price Breakdown</h2>
                    <div id="breakdown" class="space-y-2 text-sm text-gray-600">Loading breakdown...</div>
                </div>
            </div>

            <div class="md:col-span-1">
                <div class="bg-white p-6 rounded-xl shadow-lg border border-blue-50 sticky top-24">
                    <h2 class="text-xl font-bold text-blue-900 mb-6">Payment Summary</h2>
                    
                    <div class="flex justify-between items-end border-b border-gray-100 pb-6 mb-6">
                        <span class="text-gray-600 font-medium">Total Amount</span>
                        <span id="display-total" class="text-3xl font-bold text-blue-900">R 0.00</span>
                    </div>

                    <div class="mb-6">
                        <label class="text-xs font-bold text-gray-400 uppercase mb-2 block">Discount Code</label>
                        <div class="flex gap-2">
                            <input type="text" id="discount-code" placeholder="CODE" class="w-full border rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500 transition">
                            <button id="apply-btn" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-200 transition">Apply</button>
                        </div>
                        <p id="discount-msg" class="text-xs mt-2 hidden"></p>
                    </div>

                    <label class="flex items-start gap-3 mb-6 cursor-pointer group">
                        <input type="checkbox" id="terms" class="mt-1">
                        <span class="text-sm text-gray-600 group-hover:text-gray-900 transition">I agree to the Terms & Conditions</span>
                    </label>

                    <button id="pay-btn" disabled 
                        class="w-full bg-blue-900 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-blue-800 disabled:opacity-50 transition flex justify-center items-center gap-2">
                        <i class="fas fa-lock text-sm"></i> Pay Securely
                    </button>
                    
                    <p class="text-center text-xs text-gray-400 mt-4 flex justify-center items-center gap-1"><i class="fas fa-shield-alt"></i> Secured by Yoco</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        // CONFIG
        const CONFIG = {
            API_URL: "https://script.google.com/macros/s/AKfycby8SYFa8xRg2DSQIGuLv2v_7QgR93cZW384-UkbwMdQXS9fHIdmt0fRn2dlkiznaPo4/exec"
        };

        let bookingData = {};
        let appliedCode = "";

        document.addEventListener("DOMContentLoaded", () => {
            loadLocalStorage();
            if(bookingData.email) {
                calculatePricing();
                setupListeners();
            }
        });

        function loadLocalStorage() {
            try {
                const raw = localStorage.getItem('bookingData');
                if(!raw) {
                    showNotification("No booking found. Redirecting...", "error");
                    setTimeout(() => window.location.href = "booking.html", 2000);
                    return;
                }
                bookingData = JSON.parse(raw);
                bookingData.addons = JSON.parse(localStorage.getItem('bookingAddons') || '{}');

                setText('sum-name', bookingData.fullName);
                setText('sum-email', bookingData.email);
                setText('sum-phone', bookingData.phone);
                setText('sum-address', bookingData.address);
                setText('sum-service', formatStr(bookingData.serviceType));
                setText('sum-size', formatStr(bookingData.propertySize));
                setText('sum-date', `${bookingData.cleaningDate} (${bookingData.timeSlot})`);
                setText('sum-mat', bookingData.materialsOption === 'we_supply' ? 'We Supply (+R150)' : 'Customer Supplies');

            } catch(e) { console.error(e); }
        }

        function calculatePricing() {
            const prices = {
                'weekly': { '1-bedroom': 240, '2-bedroom': 320, '3-bedroom': 380, '4-bedroom': 440 },
                'biweekly': { '1-bedroom': 300, '2-bedroom': 400, '3-bedroom': 470, '4-bedroom': 540 },
                'monthly': { '1-bedroom': 360, '2-bedroom': 480, '3-bedroom': 560, '4-bedroom': 640 },
                'once_off': { '1-bedroom': 350, '2-bedroom': 450, '3-bedroom': 550, '4-bedroom': 650 },
                'deep_cleaning': { '1-bedroom': 1200, '2-bedroom': 1750, '3-bedroom': 2300, '4-bedroom': 2850 },
                'emergency': { '1-bedroom': 525, '2-bedroom': 675, '3-bedroom': 825, '4-bedroom': 975 }
            };

            const type = bookingData.serviceType || 'once_off';
            const size = bookingData.propertySize || '2-bedroom';
            
            let base = 450;
            if(prices[type] && prices[type][size]) base = prices[type][size];

            let subtotal = base;
            let html = `<div class="flex justify-between"><span>Base Service</span><span class="font-medium">R${base.toFixed(2)}</span></div>`;

            if(bookingData.materialsOption === 'we_supply' && type === 'once_off') {
                subtotal += 150;
                html += `<div class="flex justify-between"><span>Materials Supply</span><span class="font-medium">R150.00</span></div>`;
            }

            if(bookingData.isEmergency && type !== 'emergency') {
                const sur = base * 0.5;
                subtotal += sur;
                html += `<div class="flex justify-between text-orange-600"><span>Emergency Fee</span><span class="font-medium">R${sur.toFixed(2)}</span></div>`;
            }

            if(bookingData.addons) {
                Object.values(bookingData.addons).forEach(a => {
                    if(a.total && parseFloat(a.total) > 0) {
                        const cost = parseFloat(a.total);
                        subtotal += cost;
                        html += `<div class="flex justify-between"><span>${formatStr(a.key)}</span><span class="font-medium">R${cost.toFixed(2)}</span></div>`;
                    }
                });
            }

            let discountAmt = 0;
            let discountPercent = 0;

            if(appliedCode === 'WELCOME10') { discountPercent = 10; discountAmt = subtotal * 0.10; }
            if(appliedCode === 'CLEAN15') { discountPercent = 15; discountAmt = subtotal * 0.15; }
            if(appliedCode === 'NGAOYI20') { discountPercent = 20; discountAmt = subtotal * 0.20; }

            if(discountAmt > 0) {
                html += `<div class="flex justify-between text-green-600 font-bold border-t pt-2 mt-2">
                            <span>Discount (${discountPercent}% Off)</span>
                            <span>- R${discountAmt.toFixed(2)}</span>
                         </div>`;
            }

            const total = subtotal - discountAmt;
            document.getElementById('breakdown').innerHTML = html;
            document.getElementById('display-total').textContent = `R ${total.toFixed(2)}`;
        }

        function setupListeners() {
            document.getElementById('apply-btn').addEventListener('click', () => {
                const code = document.getElementById('discount-code').value.toUpperCase().trim();
                const msg = document.getElementById('discount-msg');
                const btn = document.getElementById('apply-btn');
                const input = document.getElementById('discount-code');
                
                if(['WELCOME10', 'CLEAN15', 'NGAOYI20'].includes(code)) {
                    appliedCode = code;
                    calculatePricing();
                    
                    msg.textContent = "Discount Applied Successfully!";
                    msg.className = "text-xs mt-2 text-green-600 font-medium block";
                    msg.classList.remove('hidden');
                    
                    input.disabled = true;
                    btn.disabled = true;
                    btn.textContent = "âœ“";
                    btn.className = "bg-green-100 text-green-700 px-4 py-2 rounded-lg text-sm font-bold cursor-default";
                } else {
                    msg.textContent = "Invalid Discount Code";
                    msg.className = "text-xs mt-2 text-red-500 font-medium block";
                    msg.classList.remove('hidden');
                }
            });

            document.getElementById('terms').addEventListener('change', (e) => {
                document.getElementById('pay-btn').disabled = !e.target.checked;
            });

            document.getElementById('pay-btn').addEventListener('click', async () => {
                const btn = document.getElementById('pay-btn');
                btn.disabled = true;
                btn.innerHTML = `<div class="spinner mr-2"></div> Processing...`;

                const addonKeys = [];
                if(bookingData.addons) {
                    Object.values(bookingData.addons).forEach(a => { if(a.key) addonKeys.push(a.key); });
                }

                const payload = {
                    action: 'create-checkout',
                    customerName: bookingData.fullName,
                    email: bookingData.email,
                    phone: bookingData.phone,
                    address: bookingData.address,
                    serviceDate: bookingData.cleaningDate,
                    timeSlot: bookingData.timeSlot,
                    serviceType: bookingData.serviceType,
                    propertySize: bookingData.propertySize,
                    materialOption: bookingData.materialsOption,
                    isEmergency: !!bookingData.isEmergency,
                    addons: addonKeys,
                    discountCode: appliedCode,
                    notes: bookingData.instructions || ''
                };

                try {
                    const res = await fetch(CONFIG.API_URL, {
                        method: "POST",
                        redirect: "follow",
                        headers: { "Content-Type": "text/plain;charset=utf-8" },
                        body: JSON.stringify(payload)
                    });

                    const data = await res.json();

                    if(data.success && data.checkoutUrl) {
                        showNotification("Redirecting to payment...", "success");
                        setTimeout(() => window.location.href = data.checkoutUrl, 1000);
                    } else {
                        throw new Error(data.error || "Payment initialization failed.");
                    }

                } catch(e) {
                    console.error(e);
                    showNotification(e.message, "error");
                    btn.disabled = false;
                    btn.innerHTML = "Try Again";
                }
            });
        }

        function setText(id, txt) { document.getElementById(id).textContent = txt || '-'; }
        function formatStr(s) { return s ? s.replace(/_/g, ' ').replace(/-/g, ' ').toUpperCase() : ''; }
        
        function showNotification(msg, type) {
            const div = document.createElement('div');
            const color = type === 'success' ? 'bg-green-100 border-green-500 text-green-800' : 'bg-red-100 border-red-500 text-red-800';
            div.className = `${color} border-l-4 p-4 rounded shadow-lg mb-2 flex items-center gap-2`;
            div.innerHTML = type === 'success' ? `<i class="fas fa-check-circle"></i> ${msg}` : `<i class="fas fa-exclamation-circle"></i> ${msg}`;
            document.getElementById('notification-container').appendChild(div);
            setTimeout(() => div.remove(), 4000);
        }
    </script>
</body>
</html>
