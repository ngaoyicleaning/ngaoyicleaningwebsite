<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review Booking | Ngaoyi Cleaning</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#003b6f',
                        'accent': '#00c6ff',
                        'success': '#10b981'
                    },
                    fontFamily: { 'sans': ['Segoe UI', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        .spinner { border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid #fff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="font-sans text-gray-700 bg-gray-50">

    <header class="sticky top-0 z-40 bg-white shadow-md">
        <nav class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <img src="https://raw.githubusercontent.com/ngaoyicleaning/ngaoyicleaning/main/assets/logo.png" class="w-10 h-10">
                <h1 class="text-2xl font-bold text-primary">Ngaoyi Cleaning</h1>
            </div>
        </nav>
    </header>

    <main class="py-8">
        <div class="container mx-auto px-4 mb-8">
            <div class="flex justify-center items-center text-sm font-bold text-gray-400">
                <span class="text-success"><i class="fas fa-check-circle"></i> Details</span>
                <span class="mx-4 text-primary">----------</span>
                <span class="text-success"><i class="fas fa-check-circle"></i> Add-ons</span>
                <span class="mx-4 text-primary">----------</span>
                <span class="text-primary">3. Summary</span>
            </div>
        </div>

        <div class="container mx-auto px-4 max-w-5xl">
            <h1 class="text-3xl font-bold text-primary mb-2">Review & Pay</h1>
            <p class="text-gray-600 mb-8">Finalize your booking details.</p>

            <div class="grid md:grid-cols-3 gap-8">
                
                <div class="md:col-span-2 space-y-6">
                    
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-1 h-full bg-primary"></div>
                        <h2 class="text-lg font-bold border-b pb-3 mb-4 flex items-center gap-2 text-primary">
                            <i class="fas fa-user-circle"></i> Customer
                        </h2>
                        <div class="grid sm:grid-cols-2 gap-y-4 gap-x-8 text-sm">
                            <div><p class="text-gray-400 text-xs uppercase font-bold">Name</p><p id="sum-name" class="font-medium text-lg">-</p></div>
                            <div><p class="text-gray-400 text-xs uppercase font-bold">Phone</p><p id="sum-phone" class="font-medium text-lg">-</p></div>
                            <div class="sm:col-span-2"><p class="text-gray-400 text-xs uppercase font-bold">Email</p><p id="sum-email" class="font-medium">-</p></div>
                            <div class="sm:col-span-2"><p class="text-gray-400 text-xs uppercase font-bold">Address</p><p id="sum-address" class="font-medium">-</p></div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-1 h-full bg-accent"></div>
                        <h2 class="text-lg font-bold border-b pb-3 mb-4 flex items-center gap-2 text-primary">
                            <i class="fas fa-broom"></i> Service Plan
                        </h2>
                        <div class="grid sm:grid-cols-2 gap-y-4 gap-x-8 text-sm">
                            <div><p class="text-gray-400 text-xs uppercase font-bold">Service</p><p id="sum-service" class="font-medium">-</p></div>
                            <div><p class="text-gray-400 text-xs uppercase font-bold">Size</p><p id="sum-size" class="font-medium">-</p></div>
                            <div class="sm:col-span-2"><p class="text-gray-400 text-xs uppercase font-bold">Schedule</p><p id="sum-date" class="font-medium">-</p></div>
                        </div>
                        
                        <div id="addons-section" class="mt-4 pt-4 border-t border-dashed border-gray-200 hidden">
                            <p class="text-gray-400 text-xs uppercase font-bold mb-2">Extras Included</p>
                            <div id="sum-addons" class="flex flex-wrap gap-2"></div>
                        </div>
                    </div>
                </div>

                <div class="md:col-span-1">
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-blue-50 sticky top-24">
                        <h2 class="text-xl font-bold text-primary mb-6">Total Due</h2>
                        
                        <div id="breakdown" class="space-y-3 text-sm text-gray-600 mb-6">
                            </div>

                        <div class="flex justify-between items-end border-t border-gray-200 pt-4 mb-6">
                            <span class="text-gray-900 font-bold text-lg">Total</span>
                            <span id="display-total" class="text-3xl font-extrabold text-primary">R 0.00</span>
                        </div>

                        <div class="mb-6 bg-gray-50 p-3 rounded-lg border border-gray-100">
                            <label class="text-xs font-bold text-gray-400 uppercase mb-2 block">Discount Code</label>
                            <div class="flex gap-2 relative">
                                <input type="text" id="discount-code" placeholder="CODE" class="w-full border rounded-lg px-3 py-2 text-sm uppercase outline-none focus:ring-2 focus:ring-primary">
                                <button id="apply-btn" class="bg-blue-100 text-primary px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-200">Apply</button>
                            </div>
                            <p id="discount-msg" class="text-xs mt-2 hidden font-bold"></p>
                        </div>

                        <div class="mb-6">
                            <label class="flex items-start gap-3 cursor-pointer">
                                <input type="checkbox" id="terms" class="mt-1 w-4 h-4 text-primary rounded focus:ring-primary">
                                <span class="text-sm text-gray-500">I agree to the <a href="#" class="text-primary hover:underline">Terms of Service</a>.</span>
                            </label>
                        </div>

                        <button id="pay-btn" disabled class="w-full bg-gradient-to-r from-primary to-accent text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed transition flex justify-center items-center gap-3">
                            <i class="fas fa-lock text-sm"></i> Pay Securely
                        </button>
                        
                        <div class="mt-4 flex justify-center items-center gap-2 text-xs text-gray-400">
                            <i class="fas fa-shield-alt"></i> Secured by Yoco
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // ðŸ”´ API URL
        const API_URL = "https://script.google.com/macros/s/AKfycbzQZo_rLSS86ZwuioQzdQek621SZh5vlrphB94Kql2nFVu5o_X7-p2lFr4UEHku_zgSqw/exec";

        let bookingData = {};
        let appliedCode = "";
        let currentTotal = 0;

        document.addEventListener("DOMContentLoaded", () => {
            loadData();
            
            document.getElementById('apply-btn').addEventListener('click', applyDiscount);
            document.getElementById('terms').addEventListener('change', (e) => {
                document.getElementById('pay-btn').disabled = !e.target.checked;
            });
            document.getElementById('pay-btn').addEventListener('click', initiateCheckout);
        });

        function loadData() {
            const stored = localStorage.getItem('bookingData');
            if(!stored) { window.location.href = "booking.html"; return; }
            bookingData = JSON.parse(stored);

            // Populate Text
            setText('sum-name', bookingData.name);
            setText('sum-email', bookingData.email);
            setText('sum-phone', bookingData.phone);
            setText('sum-address', bookingData.address);
            setText('sum-service', bookingData.serviceType);
            setText('sum-size', bookingData.propertySize);

            // Date Logic (Multiple vs Single)
            if (Array.isArray(bookingData.dates) && bookingData.dates.length > 1) {
                setText('sum-date', `${bookingData.dates.length} Dates Scheduled (${bookingData.time})`);
            } else if (Array.isArray(bookingData.dates)) {
                setText('sum-date', `${bookingData.dates[0]} @ ${bookingData.time}`);
            } else {
                setText('sum-date', `${bookingData.dates} @ ${bookingData.time}`);
            }

            // Add-ons Badge
            if(bookingData.addons && bookingData.addons.length > 0) {
                document.getElementById('addons-section').classList.remove('hidden');
                const counts = {};
                bookingData.addons.forEach(x => { counts[x] = (counts[x] || 0) + 1; });
                
                const html = Object.keys(counts).map(k => {
                    const name = k.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                    return `<span class="bg-blue-50 text-primary px-2 py-1 rounded text-xs border border-blue-100">${name} x${counts[k]}</span>`;
                }).join('');
                document.getElementById('sum-addons').innerHTML = html;
            }

            // Pricing
            currentTotal = bookingData.estimatedGrandTotal || bookingData.baseTotal;
            updateTotalDisplay(currentTotal);
        }

        function updateTotalDisplay(amount) {
            document.getElementById('display-total').textContent = `R ${amount.toFixed(2)}`;
            // Simple Breakdown
            let html = `<div class="flex justify-between"><span>Service Total</span><span>R ${bookingData.estimatedGrandTotal.toFixed(2)}</span></div>`;
            if (appliedCode) {
                html += `<div class="flex justify-between text-success font-bold"><span>Discount (${appliedCode})</span><span>- Applied</span></div>`;
            }
            document.getElementById('breakdown').innerHTML = html;
        }

        async function applyDiscount() {
            const code = document.getElementById('discount-code').value.trim();
            if(!code) return;
            
            const btn = document.getElementById('apply-btn');
            const msg = document.getElementById('discount-msg');
            
            btn.innerHTML = '...';
            btn.disabled = true;

            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'apply-discount', discountCode: code, subtotal: bookingData.estimatedGrandTotal })
                });
                const data = await res.json();

                if(data.success) {
                    appliedCode = code;
                    const newTotal = bookingData.estimatedGrandTotal - data.discountAmount;
                    currentTotal = newTotal;
                    updateTotalDisplay(newTotal);
                    
                    msg.textContent = `Success! ${data.discountPercent}% Off`;
                    msg.className = "text-xs mt-2 font-bold text-success block";
                    btn.innerHTML = '<i class="fas fa-check"></i>';
                } else {
                    msg.textContent = "Invalid Code";
                    msg.className = "text-xs mt-2 font-bold text-red-500 block";
                    btn.innerHTML = 'Apply';
                    btn.disabled = false;
                }
            } catch(e) {
                btn.innerHTML = 'Apply';
                btn.disabled = false;
            }
        }

        async function initiateCheckout() {
            const btn = document.getElementById('pay-btn');
            btn.disabled = true;
            btn.innerHTML = `<div class="spinner mr-2"></div> Connecting to Yoco...`;

            const payload = {
                action: 'create-checkout',
                // Data from Step 1
                name: bookingData.name,
                email: bookingData.email,
                phone: bookingData.phone,
                address: bookingData.address,
                dates: bookingData.dates, // Send Array for Calendar Logic
                time: bookingData.time,
                serviceType: bookingData.serviceType, // Readable name
                propertySize: bookingData.propertySize, // Readable name
                // Data from Step 2
                addons: bookingData.addons, // Array ['oven', 'oven']
                // Discounts
                discountCode: appliedCode,
                // Pricing handled securely on backend, but we send context
                materials: 'customer-supply' // Default or passed from Step 1
            };

            try {
                const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
                const data = await res.json();

                if(data.success && data.redirectUrl) {
                    localStorage.removeItem('bookingData'); // Clear session
                    window.location.href = data.redirectUrl;
                } else {
                    alert("Error: " + (data.error || "Payment init failed"));
                    btn.disabled = false;
                    btn.innerHTML = `Pay Securely`;
                }
            } catch(e) {
                alert("Network Error");
                btn.disabled = false;
                btn.innerHTML = `Pay Securely`;
            }
        }

        function setText(id, txt) { document.getElementById(id).textContent = txt || '-'; }
    </script>
</body>
</html>
