<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Summary | Ngaoyi Cleaning</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .spinner { border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid #fff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .spinner-blue { border: 3px solid rgba(30, 58, 138, 0.3); border-top: 3px solid #1e3a8a; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

    <header class="sticky top-0 bg-white shadow-sm z-40">
        <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-900 text-white rounded-full flex items-center justify-center font-bold shadow-sm">NC</div>
                <div>
                    <h1 class="text-xl font-bold text-blue-900 leading-none">Ngaoyi Cleaning</h1>
                    <p class="text-xs text-gray-500">Professional Services</p>
                </div>
            </div>
            <a href="booking.html" class="text-sm text-blue-900 bg-blue-50 px-4 py-2 rounded-lg hover:bg-blue-100 transition">
                <i class="fas fa-arrow-left mr-2"></i> Edit Booking
            </a>
        </nav>
    </header>

    <main class="py-10 container mx-auto px-4 max-w-5xl">
        <h1 class="text-3xl font-bold text-blue-900 mb-2">Review & Pay</h1>
        <p class="text-gray-500 mb-8">Please review your booking details below.</p>

        <div class="grid md:grid-cols-3 gap-8">
            <div class="md:col-span-2 space-y-6">
                
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1 h-full bg-blue-600"></div>
                    <h2 class="text-lg font-bold border-b pb-3 mb-4 flex items-center gap-2">
                        <i class="fas fa-user-circle text-blue-600"></i> Customer Details
                    </h2>
                    <div class="grid sm:grid-cols-2 gap-y-4 gap-x-8 text-sm">
                        <div><p class="text-gray-400 text-xs uppercase font-semibold">Full Name</p><p id="sum-name" class="font-medium text-gray-900 text-lg">-</p></div>
                        <div><p class="text-gray-400 text-xs uppercase font-semibold">Phone</p><p id="sum-phone" class="font-medium text-gray-900 text-lg">-</p></div>
                        <div class="sm:col-span-2"><p class="text-gray-400 text-xs uppercase font-semibold">Email</p><p id="sum-email" class="font-medium text-gray-900">-</p></div>
                        <div class="sm:col-span-2"><p class="text-gray-400 text-xs uppercase font-semibold">Service Address</p><p id="sum-address" class="font-medium text-gray-900">-</p></div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1 h-full bg-indigo-500"></div>
                    <h2 class="text-lg font-bold border-b pb-3 mb-4 flex items-center gap-2">
                        <i class="fas fa-broom text-indigo-500"></i> Service Details
                    </h2>
                    <div class="grid sm:grid-cols-2 gap-y-4 gap-x-8 text-sm">
                        <div><p class="text-gray-400 text-xs uppercase font-semibold">Service Type</p><p id="sum-service" class="font-medium text-gray-900">-</p></div>
                        <div><p class="text-gray-400 text-xs uppercase font-semibold">Property Size</p><p id="sum-size" class="font-medium text-gray-900">-</p></div>
                        <div><p class="text-gray-400 text-xs uppercase font-semibold">Date & Time</p><p id="sum-date" class="font-medium text-gray-900">-</p></div>
                        <div><p class="text-gray-400 text-xs uppercase font-semibold">Materials</p><p id="sum-mat" class="font-medium text-gray-900">-</p></div>
                    </div>
                    <div id="addons-container" class="mt-4 pt-4 border-t border-dashed border-gray-200 hidden">
                        <p class="text-gray-400 text-xs uppercase font-semibold mb-2">Selected Add-ons</p>
                        <div id="sum-addons" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>
            </div>

            <div class="md:col-span-1">
                <div class="bg-white p-6 rounded-xl shadow-lg border border-blue-50 sticky top-24">
                    <h2 class="text-xl font-bold text-blue-900 mb-6">Payment Summary</h2>
                    
                    <div id="breakdown" class="space-y-3 text-sm text-gray-600 mb-6">
                        Loading prices...
                    </div>

                    <div class="flex justify-between items-end border-t border-gray-200 pt-4 mb-6">
                        <span class="text-gray-900 font-bold text-lg">Total Due</span>
                        <span id="display-total" class="text-3xl font-extrabold text-blue-900">R 0.00</span>
                    </div>

                    <div class="mb-6 bg-gray-50 p-3 rounded-lg border border-gray-100">
                        <label class="text-xs font-bold text-gray-400 uppercase mb-2 block">Have a Discount Code?</label>
                        <div class="flex gap-2 relative">
                            <input type="text" id="discount-code" placeholder="Enter Code" class="w-full border rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500 uppercase transition">
                            <button id="apply-btn" class="bg-blue-100 text-blue-700 px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-200 transition">Apply</button>
                        </div>
                        <p id="discount-msg" class="text-xs mt-2 hidden font-medium"></p>
                    </div>

                    <div class="mb-6">
                        <label class="flex items-start gap-3 cursor-pointer group">
                            <input type="checkbox" id="terms" class="mt-1 w-4 h-4 text-blue-900 border-gray-300 rounded focus:ring-blue-500">
                            <div class="text-sm text-gray-500 leading-tight">
                                I agree to the 
                                <a href="#" class="text-blue-600 hover:underline">Terms of Service</a> 
                                and 
                                <a href="#" class="text-blue-600 hover:underline">Privacy Policy</a>.
                            </div>
                        </label>
                    </div>

                    <button id="pay-btn" disabled 
                        class="w-full bg-blue-900 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-blue-800 disabled:opacity-50 disabled:cursor-not-allowed transition flex justify-center items-center gap-3">
                        <i class="fas fa-lock text-sm"></i> Pay Securely
                    </button>
                    
                    <div class="mt-4 flex justify-center items-center gap-2 text-xs text-gray-400 opacity-75">
                        <i class="fas fa-shield-alt"></i> Payments secured by Yoco
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // ⬇️ UPDATED API URL
        const API_URL = "https://script.google.com/macros/s/AKfycbzkEQsrhwO9GefGpmWCGRpV_CYlF7ovPbYUjDmyd7WzePTIuA4ISPNcuqjcyNaWq2YC/exec";

        let bookingData = {};
        let appliedCode = "";
        let currentSubtotal = 0; // Tracks raw total before discount
        let discountInfo = { amount: 0, percent: 0 };

        document.addEventListener("DOMContentLoaded", () => {
            loadBookingData();
        });

        function loadBookingData() {
            try {
                const raw = localStorage.getItem('bookingData');
                if(!raw) {
                    alert("No booking found. Returning to start.");
                    window.location.href = "booking.html";
                    return;
                }
                bookingData = JSON.parse(raw);
                bookingData.addons = JSON.parse(localStorage.getItem('bookingAddons') || '{}');

                // Fill UI
                setText('sum-name', bookingData.fullName);
                setText('sum-email', bookingData.email);
                setText('sum-phone', bookingData.phone);
                setText('sum-address', bookingData.address);
                setText('sum-service', formatStr(bookingData.serviceType));
                setText('sum-size', formatStr(bookingData.propertySize));
                setText('sum-date', `${bookingData.cleaningDate} (${bookingData.timeSlot})`);
                
                // Material Logic Display
                const isDeep = bookingData.serviceType === 'deep_cleaning';
                const matText = (isDeep && bookingData.materialsOption === 'we_supply') 
                    ? 'We Supply (+R150)' 
                    : 'Customer Supplies';
                setText('sum-mat', matText);

                // Addons Display
                const addonContainer = document.getElementById('addons-container');
                const addonList = document.getElementById('sum-addons');
                let hasAddons = false;
                
                if(bookingData.addons) {
                    Object.values(bookingData.addons).forEach(a => {
                        if(parseFloat(a.total) > 0) {
                            hasAddons = true;
                            const tag = document.createElement('span');
                            tag.className = "bg-blue-50 text-blue-700 px-2 py-1 rounded text-xs font-medium border border-blue-100";
                            tag.textContent = formatStr(a.key);
                            addonList.appendChild(tag);
                        }
                    });
                }
                if(hasAddons) addonContainer.classList.remove('hidden');

                calculateLocalPricing();
                setupListeners();

            } catch(e) { console.error(e); }
        }

        function calculateLocalPricing() {
            // 1. BASE PRICES (Must match Google Sheet Defaults)
            const prices = {
                'weekly': { '1-bedroom': 240, '2-bedroom': 320, '3-bedroom': 380, '4-bedroom': 440 },
                'biweekly': { '1-bedroom': 300, '2-bedroom': 400, '3-bedroom': 470, '4-bedroom': 540 },
                'monthly': { '1-bedroom': 360, '2-bedroom': 480, '3-bedroom': 560, '4-bedroom': 640 },
                'once_off': { '1-bedroom': 350, '2-bedroom': 450, '3-bedroom': 550, '4-bedroom': 650 },
                'deep_cleaning': { '1-bedroom': 1200, '2-bedroom': 1750, '3-bedroom': 2300, '4-bedroom': 2850 },
                'emergency': { '1-bedroom': 525, '2-bedroom': 675, '3-bedroom': 825, '4-bedroom': 975 }
            };

            const type = bookingData.serviceType || 'once_off';
            const size = bookingData.propertySize || '2-bedroom';
            
            let base = 450;
            if(prices[type] && prices[type][size]) base = prices[type][size];

            // 2. Build Breakdown HTML
            let subtotal = base;
            let html = `<div class="flex justify-between"><span>Base Service</span><span class="font-medium">R ${base.toFixed(2)}</span></div>`;

            // 3. Materials (Only Deep Clean)
            if(bookingData.serviceType === 'deep_cleaning' && bookingData.materialsOption === 'we_supply') {
                subtotal += 150;
                html += `<div class="flex justify-between"><span>Cleaning Materials</span><span class="font-medium">R 150.00</span></div>`;
            }

            // 4. Emergency (50%)
            if(bookingData.isEmergency && type !== 'emergency') {
                const sur = base * 0.5;
                subtotal += sur;
                html += `<div class="flex justify-between text-orange-600"><span>Emergency Surcharge</span><span class="font-medium">R ${sur.toFixed(2)}</span></div>`;
            }

            // 5. Addons
            if(bookingData.addons) {
                Object.values(bookingData.addons).forEach(a => {
                    const cost = parseFloat(a.total);
                    if(cost > 0) {
                        subtotal += cost;
                        html += `<div class="flex justify-between text-gray-500"><span>+ ${formatStr(a.key)}</span><span>R ${cost.toFixed(2)}</span></div>`;
                    }
                });
            }

            // Update Global Subtotal
            currentSubtotal = subtotal;

            // 6. Discount Display
            const total = subtotal - discountInfo.amount;

            html += `<div class="border-t border-gray-100 my-2"></div>`;
            
            if(discountInfo.amount > 0) {
                html += `<div class="flex justify-between text-green-600 font-bold bg-green-50 p-2 rounded">
                            <span>Discount (${discountInfo.percent}% Off)</span>
                            <span>- R ${discountInfo.amount.toFixed(2)}</span>
                         </div>`;
            } else {
                 html += `<div class="flex justify-between font-semibold"><span>Subtotal</span><span>R ${subtotal.toFixed(2)}</span></div>`;
            }

            // Render
            document.getElementById('breakdown').innerHTML = html;
            document.getElementById('display-total').textContent = `R ${total.toFixed(2)}`;
        }

        function setupListeners() {
            // DISCOUNT BUTTON
            const applyBtn = document.getElementById('apply-btn');
            const codeInput = document.getElementById('discount-code');
            const msg = document.getElementById('discount-msg');

            applyBtn.addEventListener('click', async () => {
                const code = codeInput.value.trim().toUpperCase();
                if(!code) return;

                // UI Loading State
                applyBtn.disabled = true;
                applyBtn.innerHTML = `<div class="spinner-blue"></div>`;
                msg.classList.add('hidden');

                try {
                    // CALL API TO CHECK VALIDITY AND GET EXACT PERCENTAGE
                    const payload = {
                        action: 'apply-discount',
                        discountCode: code,
                        subtotal: currentSubtotal
                    };

                    const response = await fetch(API_URL, {
                        method: 'POST',
                        redirect: "follow",
                        headers: { "Content-Type": "text/plain;charset=utf-8" },
                        body: JSON.stringify(payload)
                    });

                    const res = await response.json();

                    if(res.success) {
                        // Success
                        appliedCode = code;
                        discountInfo = {
                            amount: res.discountAmount,
                            percent: res.discountPercent
                        };
                        
                        msg.textContent = `Success! ${res.discountPercent}% discount applied.`;
                        msg.className = "text-xs mt-2 font-bold text-green-600 block";
                        
                        applyBtn.innerHTML = `<i class="fas fa-check"></i>`;
                        applyBtn.className = "bg-green-100 text-green-700 px-4 py-2 rounded-lg text-sm font-bold";
                        codeInput.disabled = true;
                        
                        // Re-Calculate UI
                        calculateLocalPricing();

                    } else {
                        // Fail
                        msg.textContent = res.message || "Invalid or Expired Code";
                        msg.className = "text-xs mt-2 font-bold text-red-500 block";
                        applyBtn.innerHTML = "Apply";
                        applyBtn.disabled = false;
                        
                        discountInfo = { amount: 0, percent: 0 };
                        calculateLocalPricing();
                    }
                } catch(e) {
                    console.error(e);
                    msg.textContent = "Connection Error. Try again.";
                    msg.className = "text-xs mt-2 font-bold text-red-500 block";
                    applyBtn.innerHTML = "Apply";
                    applyBtn.disabled = false;
                }
            });

            // TERMS CHECKBOX
            document.getElementById('terms').addEventListener('change', (e) => {
                document.getElementById('pay-btn').disabled = !e.target.checked;
            });

            // PAY BUTTON
            document.getElementById('pay-btn').addEventListener('click', async () => {
                const btn = document.getElementById('pay-btn');
                btn.disabled = true;
                btn.innerHTML = `<div class="spinner mr-2"></div> Connecting to Yoco...`;

                const addonKeys = [];
                if(bookingData.addons) {
                    Object.values(bookingData.addons).forEach(a => { if(a.key) addonKeys.push(a.key); });
                }

                const payload = {
                    action: 'create-checkout',
                    customerName: bookingData.fullName,
                    email: bookingData.email,
                    phone: bookingData.phone,
                    address: bookingData.address,
                    serviceDate: bookingData.cleaningDate,
                    timeSlot: bookingData.timeSlot,
                    serviceType: bookingData.serviceType,
                    propertySize: bookingData.propertySize,
                    materialOption: bookingData.materialsOption,
                    isEmergency: !!bookingData.isEmergency,
                    addons: addonKeys,
                    discountCode: appliedCode,
                    notes: bookingData.instructions || ''
                };

                try {
                    const res = await fetch(API_URL, {
                        method: "POST",
                        redirect: "follow",
                        headers: { "Content-Type": "text/plain;charset=utf-8" },
                        body: JSON.stringify(payload)
                    });

                    const data = await res.json();

                    if(data.success && data.checkoutUrl) {
                        window.location.href = data.checkoutUrl;
                    } else {
                        alert("Error: " + (data.error || "Failed to initialize payment"));
                        btn.disabled = false;
                        btn.textContent = "Try Again";
                    }
                } catch(e) {
                    alert("Network Error. Please check your internet connection.");
                    btn.disabled = false;
                    btn.textContent = "Try Again";
                }
            });
        }

        // Helpers
        function setText(id, txt) { document.getElementById(id).textContent = txt || '-'; }
        function formatStr(s) { 
            if(!s) return '';
            return s.replace(/_/g, ' ').replace(/-/g, ' ').toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
        }
    </script>
</body>
</html>
