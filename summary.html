<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Summary | Ngaoyi Cleaning</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#003b6f',
                        'primary-light': '#0056a3',
                        'accent': '#00c6ff'
                    }
                }
            }
        }
    </script>
    
    <style>
        .loading {
            display: none;
        }
        .error {
            display: none;
            color: #dc2626;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm">
        <div class="container mx-auto px-4 py-3">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-gradient-to-br from-primary to-accent rounded-full mr-3"></div>
                <div>
                    <h1 class="text-xl font-bold text-primary">Ngaoyi Cleaning</h1>
                    <p class="text-xs text-gray-500">Booking Summary</p>
                </div>
            </div>
        </div>
    </nav>

    <!-- Progress Bar -->
    <div class="bg-white py-4 border-b">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-center mb-2">
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-primary text-white rounded-full flex items-center justify-center text-sm font-bold">1</div>
                    <div class="h-1 w-16 bg-primary"></div>
                    <div class="w-8 h-8 bg-primary text-white rounded-full flex items-center justify-center text-sm font-bold">2</div>
                    <div class="h-1 w-16 bg-primary"></div>
                    <div class="w-8 h-8 bg-primary text-white rounded-full flex items-center justify-center text-sm font-bold">3</div>
                </div>
            </div>
            <div class="flex justify-center text-xs">
                <span class="text-gray-500 mr-16">Details</span>
                <span class="text-gray-500">Add-ons</span>
                <span class="text-primary font-semibold ml-16">Summary</span>
            </div>
        </div>
    </div>

    <main class="container mx-auto px-4 py-8 max-w-4xl">
        <h1 class="text-2xl font-bold text-primary mb-2">Review & Pay</h1>
        <p class="text-gray-600 mb-8">Please review your booking details before proceeding to payment</p>

        <!-- Error Message -->
        <div id="errorMessage" class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6 hidden">
            <div class="flex items-center">
                <i class="fas fa-exclamation-circle mr-2"></i>
                <span id="errorText"></span>
            </div>
        </div>

        <div class="grid md:grid-cols-3 gap-8">
            <!-- Left Column: Booking Details -->
            <div class="md:col-span-2">
                <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
                    <!-- Customer Info -->
                    <div class="mb-6">
                        <h2 class="text-lg font-semibold text-primary mb-4 pb-2 border-b">Customer Information</h2>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-500">Full Name</p>
                                <p id="customerName" class="font-medium">Loading...</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Email</p>
                                <p id="customerEmail" class="font-medium">Loading...</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Phone</p>
                                <p id="customerPhone" class="font-medium">Loading...</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Address</p>
                                <p id="customerAddress" class="font-medium">Loading...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Service Details -->
                    <div class="mb-6">
                        <h2 class="text-lg font-semibold text-primary mb-4 pb-2 border-b">Service Details</h2>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-500">Service Type</p>
                                <p id="serviceType" class="font-medium">Loading...</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Property Size</p>
                                <p id="propertySize" class="font-medium">Loading...</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Date</p>
                                <p id="cleaningDate" class="font-medium">Loading...</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Time Slot</p>
                                <p id="timeSlot" class="font-medium">Loading...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Add-ons -->
                    <div id="addonsSection" class="mb-6">
                        <h2 class="text-lg font-semibold text-primary mb-4 pb-2 border-b">Add-on Services</h2>
                        <div id="addonsList" class="space-y-2">
                            <!-- Add-ons will be added here -->
                        </div>
                    </div>

                    <!-- Edit Links -->
                    <div class="flex space-x-4 text-sm">
                        <a href="/booking.html" class="text-primary hover:text-accent font-medium">
                            <i class="fas fa-edit mr-1"></i> Edit Details
                        </a>
                        <a href="/booking-addons.html" class="text-primary hover:text-accent font-medium">
                            <i class="fas fa-edit mr-1"></i> Edit Add-ons
                        </a>
                    </div>
                </div>
            </div>

            <!-- Right Column: Payment -->
            <div class="md:col-span-1">
                <div class="bg-white rounded-lg shadow-sm border p-6 sticky top-6">
                    <h2 class="text-lg font-semibold text-primary mb-4">Payment Summary</h2>
                    
                    <div class="space-y-3 mb-6">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Base Service:</span>
                            <span id="basePrice" class="font-medium">R 0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Materials:</span>
                            <span id="materialsPrice" class="font-medium">R 0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Emergency Fee:</span>
                            <span id="emergencyFee" class="font-medium">R 0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Add-ons:</span>
                            <span id="addonsTotal" class="font-medium">R 0</span>
                        </div>
                        
                        <!-- Discount -->
                        <div class="border-t pt-3 mt-3">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-gray-600">Discount:</span>
                                <button id="applyDiscount" class="text-sm text-primary font-medium hover:text-accent">Apply Code</button>
                            </div>
                            <input type="text" id="discountCode" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded text-sm mb-2"
                                   placeholder="Enter discount code">
                            <div id="discountMessage" class="text-sm hidden"></div>
                        </div>
                        
                        <div class="border-t pt-3">
                            <div class="flex justify-between">
                                <span class="text-gray-700 font-semibold">Subtotal:</span>
                                <span id="subtotal" class="font-semibold">R 0</span>
                            </div>
                            <div class="flex justify-between mt-2">
                                <span class="text-gray-700 font-semibold">Discount:</span>
                                <span id="discountAmount" class="text-green-600 font-semibold">- R 0</span>
                            </div>
                            <div class="flex justify-between mt-3 pt-3 border-t">
                                <span class="text-lg font-bold text-primary">Total:</span>
                                <span id="totalAmount" class="text-2xl font-bold text-primary">R 0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Terms -->
                    <div class="mb-6">
                        <div class="flex items-start">
                            <input type="checkbox" id="agreeTerms" class="mt-1 mr-2">
                            <label for="agreeTerms" class="text-sm text-gray-600">
                                I agree to the <a href="/terms.html" class="text-primary hover:text-accent">Terms & Conditions</a> 
                                and <a href="/privacy.html" class="text-primary hover:text-accent">Privacy Policy</a>
                            </label>
                        </div>
                    </div>

                    <!-- Pay Button -->
                    <button id="payButton"
                            class="w-full bg-gradient-to-r from-primary to-accent text-white py-3 rounded-lg font-semibold hover:shadow-lg transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled>
                        <span id="payText">
                            <i class="fas fa-lock mr-2"></i> Pay Securely
                        </span>
                        <span id="payLoading" class="hidden">
                            <i class="fas fa-spinner fa-spin mr-2"></i> Processing...
                        </span>
                    </button>

                    <p class="text-center text-gray-500 text-xs mt-4">
                        <i class="fas fa-shield-alt mr-1"></i> Secure payment by Yoco
                    </p>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p class="text-gray-400">Need help? Call <a href="tel:0707643709" class="text-accent">070 764 3709</a></p>
            <div class="mt-4 space-x-4">
                <a href="/privacy.html" class="text-gray-400 hover:text-accent text-sm">Privacy</a>
                <a href="/terms.html" class="text-gray-400 hover:text-accent text-sm">Terms</a>
            </div>
            <p class="text-gray-500 text-xs mt-4">&copy; 2024 Ngaoyi Cleaning</p>
        </div>
    </footer>

    <!-- Script -->
    <script>
        // Configuration - REPLACE WITH YOUR GOOGLE APPS SCRIPT URL
        const GAS_ENDPOINT_URL = "https://script.google.com/macros/s/AKfycbwSzT-6G5xgklunf2KbGqGRr7KvnaSkikxSB4Kebq90vKtMjhw0UVVWtNyhjbTZEf3h7g/exec";
        
        // Load booking data from localStorage
        document.addEventListener('DOMContentLoaded', function() {
            loadBookingData();
            setupEventListeners();
        });

        function loadBookingData() {
            try {
                const bookingData = JSON.parse(localStorage.getItem('bookingData') || '{}');
                const addonsData = JSON.parse(localStorage.getItem('bookingAddons') || '{}');
                
                if (!bookingData.fullName) {
                    showError('No booking data found. Please start a new booking.');
                    return;
                }

                // Populate customer info
                document.getElementById('customerName').textContent = bookingData.fullName || 'Not provided';
                document.getElementById('customerEmail').textContent = bookingData.email || 'Not provided';
                document.getElementById('customerPhone').textContent = bookingData.phone || 'Not provided';
                document.getElementById('customerAddress').textContent = bookingData.address || 'Not provided';

                // Populate service details
                document.getElementById('serviceType').textContent = getServiceTypeName(bookingData.serviceType);
                document.getElementById('propertySize').textContent = getPropertySizeName(bookingData.propertySize);
                document.getElementById('cleaningDate').textContent = formatDate(bookingData.cleaningDate);
                document.getElementById('timeSlot').textContent = getTimeSlotName(bookingData.timeSlot);

                // Calculate and display pricing
                displayPricing(bookingData, addonsData);

                // Display add-ons
                displayAddons(addonsData);

            } catch (error) {
                console.error('Error loading booking data:', error);
                showError('Error loading booking details. Please try again.');
            }
        }

        function displayPricing(bookingData, addonsData) {
            const basePrice = parseFloat(bookingData.basePrice) || 0;
            const materialsPrice = bookingData.materialsOption === 'we-supply' ? 150 : 0;
            const emergencyFee = parseFloat(bookingData.emergencySurcharge) || 0;
            
            // Calculate add-ons total
            let addonsTotal = 0;
            if (addonsData) {
                Object.values(addonsData).forEach(addon => {
                    addonsTotal += addon.total || 0;
                });
            }

            const subtotal = basePrice + materialsPrice + emergencyFee + addonsTotal;
            let discountAmount = 0;
            const total = subtotal - discountAmount;

            // Update display
            document.getElementById('basePrice').textContent = formatCurrency(basePrice);
            document.getElementById('materialsPrice').textContent = formatCurrency(materialsPrice);
            document.getElementById('emergencyFee').textContent = formatCurrency(emergencyFee);
            document.getElementById('addonsTotal').textContent = formatCurrency(addonsTotal);
            document.getElementById('subtotal').textContent = formatCurrency(subtotal);
            document.getElementById('discountAmount').textContent = '- ' + formatCurrency(discountAmount);
            document.getElementById('totalAmount').textContent = formatCurrency(total);

            // Save for later use
            window.bookingData = {
                ...bookingData,
                addons: JSON.stringify(addonsData),
                subtotal: subtotal,
                totalAmount: total
            };
        }

        function displayAddons(addonsData) {
            const addonsList = document.getElementById('addonsList');
            const addonsSection = document.getElementById('addonsSection');
            
            if (!addonsData || Object.keys(addonsData).length === 0) {
                addonsSection.style.display = 'none';
                return;
            }

            let hasAddons = false;
            addonsList.innerHTML = '';

            const addonNames = {
                'windows': 'Window Cleaning',
                'oven': 'Oven Cleaning',
                'fridge': 'Fridge Cleaning',
                'laundry': 'Laundry Service',
                'carpet': 'Carpet Cleaning',
                'blinds': 'Blind Cleaning'
            };

            Object.keys(addonsData).forEach(key => {
                if (addonsData[key].quantity > 0) {
                    hasAddons = true;
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center';
                    div.innerHTML = `
                        <span class="text-sm">${addonNames[key] || key}</span>
                        <span class="text-sm font-medium">R ${addonsData[key].total || 0}</span>
                    `;
                    addonsList.appendChild(div);
                }
            });

            if (!hasAddons) {
                addonsSection.style.display = 'none';
            }
        }

        function setupEventListeners() {
            // Terms checkbox
            const termsCheckbox = document.getElementById('agreeTerms');
            const payButton = document.getElementById('payButton');

            termsCheckbox.addEventListener('change', function() {
                payButton.disabled = !this.checked;
            });

            // Discount code
            document.getElementById('applyDiscount').addEventListener('click', function() {
                const code = document.getElementById('discountCode').value.trim().toUpperCase();
                const message = document.getElementById('discountMessage');
                
                if (!code) {
                    showDiscountMessage('Please enter a discount code', 'error');
                    return;
                }

                // Valid discount codes
                const validCodes = {
                    'WELCOME10': 0.10,
                    'CLEAN15': 0.15,
                    'FIRST20': 0.20
                };

                if (validCodes[code]) {
                    const discountPercent = validCodes[code];
                    const subtotal = parseFloat(document.getElementById('subtotal').textContent.replace('R ', '').replace(',', ''));
                    const discountAmount = subtotal * discountPercent;
                    const total = subtotal - discountAmount;

                    // Update display
                    document.getElementById('discountAmount').textContent = '- ' + formatCurrency(discountAmount);
                    document.getElementById('totalAmount').textContent = formatCurrency(total);

                    // Update booking data
                    window.bookingData.discountCode = code;
                    window.bookingData.discountAmount = discountAmount;
                    window.bookingData.totalAmount = total;

                    showDiscountMessage(`Discount applied: ${discountPercent * 100}% off!`, 'success');
                    
                    // Disable discount field
                    document.getElementById('discountCode').disabled = true;
                    this.disabled = true;
                    this.textContent = 'Applied';
                } else {
                    showDiscountMessage('Invalid discount code', 'error');
                }
            });

            // Pay button
            payButton.addEventListener('click', processPayment);
        }

        async function processPayment() {
            if (!window.bookingData) {
                showError('Booking data not found');
                return;
            }

            // Show loading
            document.getElementById('payText').classList.add('hidden');
            document.getElementById('payLoading').classList.remove('hidden');
            document.getElementById('payButton').disabled = true;

            try {
                // Step 1: Create booking in Google Apps Script
                const createBookingResponse = await fetch(GAS_ENDPOINT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'create_booking',
                        bookingData: window.bookingData
                    })
                });

                const bookingResult = await createBookingResponse.json();
                
                if (!bookingResult.success) {
                    throw new Error(bookingResult.error?.message || 'Failed to create booking');
                }

                const bookingRef = bookingResult.bookingRef;
                
                // Step 2: Create Yoco checkout
                const checkoutResponse = await fetch(GAS_ENDPOINT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'create_yoco_checkout',
                        bookingRef: bookingRef,
                        bookingData: window.bookingData
                    })
                });

                const checkoutResult = await checkoutResponse.json();
                
                if (!checkoutResult.success) {
                    throw new Error(checkoutResult.error?.message || 'Failed to create checkout');
                }

                // Step 3: Redirect to Yoco checkout
                if (checkoutResult.redirectUrl) {
                    window.location.href = checkoutResult.redirectUrl;
                } else {
                    throw new Error('No checkout URL received');
                }

            } catch (error) {
                console.error('Payment error:', error);
                showError('Payment failed: ' + error.message);
                
                // Reset button
                document.getElementById('payText').classList.remove('hidden');
                document.getElementById('payLoading').classList.add('hidden');
                document.getElementById('payButton').disabled = false;
            }
        }

        // Helper functions
        function getServiceTypeName(type) {
            const types = {
                'weekly': 'Weekly',
                'biweekly': 'Bi-weekly',
                'monthly': 'Monthly',
                'once-off': 'Once-Off',
                'deep': 'Deep Clean',
                'emergency': 'Emergency',
                'commercial': 'Commercial'
            };
            return types[type] || type;
        }

        function getPropertySizeName(size) {
            const sizes = {
                '1-bed': '1 Bedroom',
                '2-bed': '2 Bedroom',
                '3-bed': '3 Bedroom',
                '4-bed': '4 Bedroom',
                '5+bed': '5+ Bedroom',
                'office': 'Office'
            };
            return sizes[size] || size;
        }

        function getTimeSlotName(slot) {
            const slots = {
                '9am': '9:00 AM',
                '11am': '11:00 AM',
                '1pm': '1:00 PM'
            };
            return slots[slot] || slot;
        }

        function formatDate(dateString) {
            if (!dateString) return 'Not set';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-ZA', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function formatCurrency(amount) {
            return 'R ' + parseFloat(amount).toLocaleString('en-ZA', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').classList.remove('hidden');
        }

        function showDiscountMessage(message, type) {
            const element = document.getElementById('discountMessage');
            element.textContent = message;
            element.className = 'text-sm ' + (type === 'success' ? 'text-green-600' : 'text-red-600');
            element.classList.remove('hidden');
            
            setTimeout(() => {
                element.classList.add('hidden');
            }, 5000);
        }
    </script>
</body>
</html>
