<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review Booking | Ngaoyi Cleaning</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#003b6f',
                        'primary-light': '#0056a3',
                        'accent': '#00c6ff',
                        'success': '#10b981',
                        'bg-light': '#f8fafc'
                    },
                    fontFamily: { 'sans': ['Segoe UI', 'Tahoma', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        .spinner { border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid #fff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .receipt-row { display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px dashed #e2e8f0; font-size: 0.9rem; align-items: center; }
        .receipt-row:last-child { border-bottom: none; }
        .receipt-label { color: #64748b; font-weight: 500; }
        .receipt-value { font-weight: 700; color: #1e293b; text-align: right; }
        .receipt-sub { font-size: 0.75rem; color: #94a3b8; font-weight: normal; display: block; margin-top: 2px; }
    </style>
</head>
<body class="font-sans text-slate-800 bg-gray-50">

    <header class="sticky top-0 z-40 bg-white shadow-md">
        <nav class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <img src="https://raw.githubusercontent.com/ngaoyicleaning/ngaoyicleaning/main/assets/logo.png" class="w-10 h-10 object-contain">
                <div>
                    <h1 class="text-2xl font-bold text-primary leading-none">Ngaoyi Cleaning</h1>
                    <p class="text-xs text-gray-500 font-semibold tracking-wide">GAUTENG</p>
                </div>
            </div>
        </nav>
    </header>

    <main class="py-8">
        <div class="container mx-auto px-4 mb-8">
            <div class="flex justify-center items-center text-sm font-bold">
                <a href="booking.html" class="text-success hover:text-green-600 flex items-center gap-1 transition"><i class="fas fa-check-circle"></i> 1. Details</a>
                <span class="mx-4 text-gray-300"><i class="fas fa-chevron-right"></i></span>
                <a href="booking-addons.html" class="text-success hover:text-green-600 flex items-center gap-1 transition"><i class="fas fa-check-circle"></i> 2. Add-ons</a>
                <span class="mx-4 text-gray-300"><i class="fas fa-chevron-right"></i></span>
                <span class="text-primary border-b-2 border-primary pb-1">3. Payment</span>
            </div>
        </div>

        <div class="container mx-auto px-4 max-w-6xl">
            <div class="flex flex-col lg:flex-row gap-8">
                
                <div class="lg:w-2/3 space-y-6">
                    <h1 class="text-3xl font-bold text-primary mb-2">Review Booking</h1>
                    <p class="text-gray-600">Please verify your details before payment.</p>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="bg-blue-50 px-6 py-4 border-b border-blue-100 flex justify-between items-center">
                            <h2 class="font-bold text-primary flex items-center gap-2"><i class="fas fa-calendar-check"></i> Service Schedule</h2>
                            <a href="booking.html" class="text-xs text-blue-600 hover:underline font-bold">Edit</a>
                        </div>
                        <div class="p-6 grid md:grid-cols-2 gap-6">
                            <div><p class="text-xs text-gray-400 uppercase font-bold mb-1">Plan</p><p id="sum-service" class="font-bold text-gray-800 text-lg">-</p><p id="sum-size" class="text-sm text-gray-500">-</p></div>
                            <div><p class="text-xs text-gray-400 uppercase font-bold mb-1">Time Slot</p><p id="sum-time" class="font-bold text-gray-800 text-lg">-</p></div>
                            <div class="md:col-span-2"><p class="text-xs text-gray-400 uppercase font-bold mb-2">Selected Dates</p><div id="sum-dates-list" class="flex flex-wrap gap-2"></div></div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="bg-gray-50 px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                            <h2 class="font-bold text-gray-700 flex items-center gap-2"><i class="fas fa-user"></i> Contact & Location</h2>
                            <a href="booking.html" class="text-xs text-blue-600 hover:underline font-bold">Edit</a>
                        </div>
                        <div class="p-6 grid md:grid-cols-2 gap-6">
                            <div><p class="text-xs text-gray-400 uppercase font-bold mb-1">Full Name</p><p id="sum-name" class="font-medium">-</p></div>
                            <div><p class="text-xs text-gray-400 uppercase font-bold mb-1">Phone</p><p id="sum-phone" class="font-medium">-</p></div>
                            <div class="md:col-span-2"><p class="text-xs text-gray-400 uppercase font-bold mb-1">Email</p><p id="sum-email" class="font-medium">-</p></div>
                            <div class="md:col-span-2"><p class="text-xs text-gray-400 uppercase font-bold mb-1">Address</p><p id="sum-address" class="font-medium text-gray-800 bg-gray-50 p-2 rounded border border-gray-200">-</p></div>
                            <div class="md:col-span-2"><p class="text-xs text-gray-400 uppercase font-bold mb-1">Access Notes</p><p id="sum-notes" class="text-sm text-gray-500 italic">None provided.</p></div>
                        </div>
                    </div>
                </div>

                <div class="lg:w-1/3">
                    <div class="bg-white rounded-xl shadow-xl border border-blue-100 sticky top-24 overflow-hidden">
                        <div class="bg-primary px-6 py-4 text-white">
                            <h2 class="text-lg font-bold">Order Summary</h2>
                        </div>
                        
                        <div class="p-6 space-y-4">
                            <div id="receipt-body">
                                </div>

                            <div class="border-t border-gray-100 pt-3 space-y-2">
                                <div class="receipt-row">
                                    <span class="receipt-label">Assigned Cleaner</span>
                                    <span class="receipt-value text-orange-500 text-sm">
                                        <i class="fas fa-clock mr-1"></i> To be assigned
                                    </span>
                                </div>
                                <div class="receipt-row">
                                    <span class="receipt-label">Payment Status</span>
                                    <span class="receipt-value text-red-500 text-sm">Unpaid</span>
                                </div>
                            </div>

                            <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4">
                                <label class="text-xs font-bold text-gray-400 uppercase mb-2 block">Promo Code</label>
                                <div class="flex gap-2">
                                    <input type="text" id="discount-code" placeholder="CODE" class="w-full border rounded px-3 py-2 text-sm uppercase outline-none focus:ring-1 focus:ring-primary">
                                    <button id="apply-btn" class="bg-white border border-gray-300 text-gray-600 px-3 py-2 rounded text-xs font-bold hover:bg-gray-100">APPLY</button>
                                </div>
                                <p id="discount-msg" class="text-xs mt-1 hidden"></p>
                            </div>

                            <div class="border-t-2 border-gray-100 pt-4 flex justify-between items-end">
                                <div><p class="text-sm text-gray-500">Total Due</p><p class="text-xs text-gray-400">(incl. VAT)</p></div>
                                <div class="text-right"><span id="display-total" class="text-3xl font-extrabold text-primary">R 0.00</span></div>
                            </div>

                            <div class="text-xs text-gray-500 flex items-start gap-2 pt-2">
                                <input type="checkbox" id="terms" class="mt-1 flex-shrink-0">
                                <label for="terms" class="cursor-pointer">I agree to the <a href="terms.html" target="_blank" class="text-blue-600 underline hover:text-blue-800">Terms of Service</a> & <a href="privacy.html" target="_blank" class="text-blue-600 underline hover:text-blue-800">Privacy Policy</a>.</label>
                            </div>

                            <button id="pay-btn" disabled class="w-full bg-accent hover:bg-cyan-400 text-white py-4 rounded-lg font-bold text-lg shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed flex justify-center items-center gap-2">
                                <i class="fas fa-lock text-sm"></i> Pay Securely
                            </button>
                            
                            <div class="text-center">
                                <span class="text-xs text-gray-400 flex justify-center items-center gap-1"><i class="fas fa-shield-alt"></i> Secure Payment by Yoco</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <script>
        // ðŸ”´ UPDATED API URL
        const API_URL = "https://script.google.com/macros/s/AKfycbzQZo_rLSS86ZwuioQzdQek621SZh5vlrphB94Kql2nFVu5o_X7-p2lFr4UEHku_zgSqw/exec";

        let bookingData = {};
        let currentTotal = 0;
        let appliedDiscount = null;

        document.addEventListener("DOMContentLoaded", () => {
            loadData();
            document.getElementById('apply-btn').addEventListener('click', applyDiscount);
            document.getElementById('terms').addEventListener('change', (e) => {
                document.getElementById('pay-btn').disabled = !e.target.checked;
            });
            document.getElementById('pay-btn').addEventListener('click', initiateCheckout);
        });

        function loadData() {
            const raw = localStorage.getItem('bookingData');
            if(!raw) { window.location.href = "booking.html"; return; }
            bookingData = JSON.parse(raw);
            const addonRaw = localStorage.getItem('bookingAddons');
            if(addonRaw) bookingData.addonsDetails = JSON.parse(addonRaw);

            setText('sum-name', bookingData.name);
            setText('sum-phone', bookingData.phone);
            setText('sum-email', bookingData.email);
            setText('sum-address', bookingData.address);
            setText('sum-service', bookingData.serviceType);
            setText('sum-size', bookingData.propertySize);
            setText('sum-time', bookingData.time);
            setText('sum-notes', bookingData.notes || "None provided.");

            const datesDiv = document.getElementById('sum-dates-list');
            if (Array.isArray(bookingData.dates) && bookingData.dates.length > 0) {
                bookingData.dates.forEach(d => {
                    const badge = document.createElement('span');
                    badge.className = "bg-blue-50 text-blue-700 px-3 py-1 rounded-full text-xs font-bold border border-blue-100";
                    badge.textContent = d;
                    datesDiv.appendChild(badge);
                });
            } else { datesDiv.innerHTML = '<span class="text-gray-400 italic">No dates selected</span>'; }

            generateReceipt();
        }

        function generateReceipt() {
            const container = document.getElementById('receipt-body');
            let html = '';

            const visitCount = bookingData.dates ? bookingData.dates.length : 1;
            const ratePerVisit = bookingData.baseTotal / visitCount; 
            
            // Base Plan Row
            html += `
                <div class="receipt-row">
                    <span class="receipt-label">Cleaning Plan<span class="receipt-sub">${bookingData.propertySize} (${visitCount} visits)</span></span>
                    <span class="receipt-value">R ${bookingData.baseTotal.toFixed(2)}</span>
                </div>`;

            // Add-ons Rows
            let addonsTotal = 0;
            if(bookingData.addonsDetails) {
                Object.keys(bookingData.addonsDetails).forEach(key => {
                    const item = bookingData.addonsDetails[key];
                    if(item.quantity > 0) {
                        const name = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        html += `
                            <div class="receipt-row">
                                <span class="receipt-label">${name} <span class="receipt-sub">x${item.quantity}</span></span>
                                <span class="receipt-value">R ${item.total.toFixed(2)}</span>
                            </div>`;
                        addonsTotal += item.total;
                    }
                });
            }

            const matPrice = Number(bookingData.materialsPrice || 0);
            if(matPrice > 0) html += createRow('Cleaning Materials', `R ${matPrice.toFixed(2)}`);

            const surgPrice = Number(bookingData.emergencySurcharge || 0);
            if(surgPrice > 0) html += createRow('Emergency Surcharge', `R ${surgPrice.toFixed(2)}`);

            const subtotal = bookingData.baseTotal + addonsTotal + matPrice + surgPrice;
            html += `<div class="border-t border-gray-200 my-2"></div>`;
            
            if(appliedDiscount) {
                html += createRow('Subtotal', `R ${subtotal.toFixed(2)}`);
                html += `
                    <div class="flex justify-between items-center text-success font-bold text-sm py-1">
                        <span>Discount (${appliedDiscount.percent}%)</span>
                        <span>- R ${appliedDiscount.amount.toFixed(2)}</span>
                    </div>`;
                currentTotal = subtotal - appliedDiscount.amount;
            } else {
                currentTotal = subtotal;
            }

            container.innerHTML = html;
            document.getElementById('display-total').textContent = `R ${currentTotal.toFixed(2)}`;
        }

        function createRow(label, value) {
            return `<div class="receipt-row"><span class="receipt-label">${label}</span><span class="receipt-value">${value}</span></div>`;
        }

        async function applyDiscount() {
            const code = document.getElementById('discount-code').value.trim();
            if(!code) return;
            const btn = document.getElementById('apply-btn');
            const msg = document.getElementById('discount-msg');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            try {
                const rawTotal = currentTotal + (appliedDiscount ? appliedDiscount.amount : 0);
                const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'apply-discount', discountCode: code, subtotal: rawTotal }) });
                const data = await res.json();

                if(data.success) {
                    appliedDiscount = { code: code, amount: data.discountAmount, percent: data.discountPercent };
                    msg.textContent = "Discount Applied!";
                    msg.className = "text-xs mt-1 text-green-600 font-bold block";
                    generateReceipt();
                } else {
                    msg.textContent = "Invalid Code";
                    msg.className = "text-xs mt-1 text-red-500 font-bold block";
                    appliedDiscount = null;
                    generateReceipt();
                }
            } catch(e) {}
            btn.innerHTML = 'APPLY';
        }

        async function initiateCheckout() {
            const btn = document.getElementById('pay-btn');
            btn.disabled = true;
            btn.innerHTML = `<div class="spinner mr-2"></div> Processing...`;

            let addonArray = [];
            if(bookingData.addonsDetails) {
                Object.keys(bookingData.addonsDetails).forEach(k => {
                    const qty = bookingData.addonsDetails[k].quantity;
                    for(let i=0; i<qty; i++) addonArray.push(k);
                });
            }

            const payload = {
                action: 'create-checkout',
                name: bookingData.name,
                email: bookingData.email,
                phone: bookingData.phone,
                address: bookingData.address,
                dates: bookingData.dates,
                time: bookingData.time,
                serviceType: bookingData.serviceType,
                propertySize: bookingData.propertySize,
                addons: addonArray,
                discountCode: appliedDiscount ? appliedDiscount.code : "",
                materials: 'customer-supply'
            };

            try {
                const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
                const data = await res.json();
                if(data.success && data.redirectUrl) {
                    localStorage.removeItem('bookingData');
                    localStorage.removeItem('bookingAddons');
                    window.location.href = data.redirectUrl;
                } else {
                    alert("Payment Error: " + (data.error || "Unknown"));
                    btn.disabled = false;
                    btn.innerHTML = `<i class="fas fa-lock text-sm"></i> Pay Securely`;
                }
            } catch(e) {
                alert("Network Connection Error");
                btn.disabled = false;
                btn.innerHTML = `<i class="fas fa-lock text-sm"></i> Pay Securely`;
            }
        }

        function setText(id, txt) { document.getElementById(id).textContent = txt || '-'; }
    </script>
</body>
</html>
