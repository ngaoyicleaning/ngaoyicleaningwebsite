<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Cleaning Service | Ngaoyi Cleaning</title>
    <meta name="description" content="Book professional cleaning services in Gauteng. Secure your slot online.">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#003b6f',
                        'primary-light': '#0056a3',
                        'accent': '#00c6ff',
                        'success': '#10b981'
                    },
                    fontFamily: { 'sans': ['Segoe UI', 'Tahoma', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        .flatpickr-day.selected { background: #003b6f !important; border-color: #003b6f !important; }
        .disabled-btn { opacity: 0.5; cursor: not-allowed; filter: grayscale(100%); }
        /* Google Autocomplete Styling */
        .pac-container { border-radius: 8px; margin-top: 5px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 1px solid #e2e8f0; font-family: 'Segoe UI', sans-serif; }
        .pac-item { padding: 10px; font-size: 14px; cursor: pointer; }
        .pac-item:hover { background-color: #f1f5f9; }
        .pac-item-query { font-size: 14px; color: #003b6f; font-weight: 600; }
    </style>
</head>
<body class="font-sans text-gray-700 bg-gray-50">
    
    <header class="sticky top-0 z-40 bg-white shadow-md">
        <nav class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <img src="https://raw.githubusercontent.com/ngaoyicleaning/ngaoyicleaning/main/assets/logo.png" class="w-10 h-10 object-contain">
                <div>
                    <h1 class="text-2xl font-bold text-primary leading-none">Ngaoyi Cleaning</h1>
                    <p class="text-xs text-gray-500 font-semibold tracking-wide">GAUTENG</p>
                </div>
            </div>
            <div class="hidden md:flex space-x-6 text-sm font-semibold">
                <a href="index.html" class="hover:text-primary">Home</a>
                <a href="services.html" class="hover:text-primary">Services</a>
                <a href="pricing.html" class="hover:text-primary">Pricing</a>
            </div>
        </nav>
    </header>

    <main class="py-8">
        <div class="container mx-auto px-4 mb-8">
            <div class="flex justify-center items-center text-sm font-bold text-gray-400">
                <span class="text-primary border-b-2 border-primary pb-1">1. Booking Details</span>
                <span class="mx-4 text-gray-300"><i class="fas fa-chevron-right"></i></span>
                <span>2. Add-ons</span>
                <span class="mx-4 text-gray-300"><i class="fas fa-chevron-right"></i></span>
                <span>3. Payment</span>
            </div>
        </div>

        <section class="container mx-auto px-4 max-w-4xl">
            <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-100">
                <div class="bg-primary px-6 py-4">
                    <h1 class="text-xl font-bold text-white flex items-center gap-2">
                        <i class="fas fa-calendar-alt"></i> Schedule Your Clean
                    </h1>
                    <p class="text-blue-200 text-sm">We serve Johannesburg, Pretoria, Sandton, Midrand, Centurion & surrounds.</p>
                </div>
                
                <form id="booking-form" class="p-6 md:p-8">
                    
                    <div class="mb-8">
                        <h2 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Contact Information</h2>
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-1">Full Name *</label>
                                <input type="text" id="full-name" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary outline-none transition" placeholder="John Doe">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-1">Email Address *</label>
                                <input type="email" id="email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary outline-none transition" placeholder="john@example.com">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-1">Phone Number *</label>
                                <input type="tel" id="phone" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary outline-none transition" placeholder="072 123 4567">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-1">Service Address *</label>
                                <div class="relative">
                                    <i class="fas fa-map-marker-alt absolute left-3 top-3.5 text-gray-400"></i>
                                    <input type="text" id="address" required 
                                           class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary outline-none transition" 
                                           placeholder="Start typing your address...">
                                </div>
                                <p id="address-error" class="text-xs text-red-500 mt-1 hidden font-bold"><i class="fas fa-times-circle"></i> We do not serve this area yet.</p>
                                <p id="address-success" class="text-xs text-green-600 mt-1 hidden font-bold"><i class="fas fa-check-circle"></i> Location Verified</p>
                            </div>
                        </div>
                    </div>

                    <div class="mb-8">
                        <h2 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Service Details</h2>
                        
                        <div class="grid md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-1">Service Plan *</label>
                                <select id="service-type" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-primary">
                                    <option value="">Select a Plan...</option>
                                    <option value="weekly">Weekly Recurring (4 Visits/Month)</option>
                                    <option value="biweekly">Bi-weekly Recurring (2 Visits/Month)</option>
                                    <option value="monthly">Monthly Recurring (1 Visit/Month)</option>
                                    <option value="once-off">Once-Off / Spring Clean</option>
                                    <option value="deep">Deep Cleaning (Intensive)</option>
                                    <option value="emergency">Emergency Service</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-1">Property Size *</label>
                                <select id="property-size" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-primary">
                                    <option value="">Select Size...</option>
                                    <option value="1-bed">1-Bedroom</option>
                                    <option value="2-bed">2-Bedroom</option>
                                    <option value="3-bed">3-Bedroom</option>
                                    <option value="4-bed">4-Bedroom</option>
                                    <option value="office">Office/Commercial</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-6 p-5 bg-blue-50 rounded-xl border border-blue-100 transition-all" id="calendar-wrapper">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-sm font-bold text-primary">Select Date(s) *</label>
                                <span id="date-counter" class="text-xs font-bold text-white bg-primary px-2 py-1 rounded hidden">0 Selected</span>
                            </div>
                            
                            <div class="relative">
                                <i class="fas fa-calendar-alt absolute left-3 top-3.5 text-gray-400"></i>
                                <input type="text" id="calendar-input" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg bg-white cursor-pointer focus:ring-2 focus:ring-primary" placeholder="Choose a plan to unlock calendar" disabled>
                            </div>
                            
                            <p id="calendar-hint" class="text-xs text-gray-500 mt-2 flex items-center gap-1">
                                <i class="fas fa-info-circle"></i> Please select a service plan first.
                            </p>
                        </div>

                        <div class="grid md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-1">Start Time *</label>
                                <select id="time-slot" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-primary">
                                    <option value="08:00">08:00 AM</option>
                                    <option value="09:00">09:00 AM</option>
                                    <option value="10:00">10:00 AM</option>
                                    <option value="11:00">11:00 AM</option>
                                    <option value="12:00">12:00 PM</option>
                                    <option value="13:00">01:00 PM</option>
                                    <option value="14:00">02:00 PM</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-1">Access Notes</label>
                                <textarea id="instructions" rows="1" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary outline-none" placeholder="Gate codes, key location..."></textarea>
                            </div>
                        </div>
                        
                        <div class="text-xs text-gray-500 bg-gray-50 p-2 rounded border border-gray-100 mb-6">
                            <i class="fas fa-info-circle mr-1"></i> Please note: Ngaoyi Cleaning staff will arrive with equipment. Please ensure you have basic cleaning agents (bleach, polish) unless you selected a Deep Clean.
                        </div>
                    </div>

                    <div class="bg-slate-900 text-white p-6 rounded-xl flex flex-col md:flex-row justify-between items-center shadow-lg">
                        <div class="mb-4 md:mb-0">
                            <p class="text-gray-400 text-xs uppercase font-bold tracking-wider">Estimated Total</p>
                            <div class="flex items-baseline gap-2">
                                <h3 class="text-3xl font-bold" id="subtotal">R 0.00</h3>
                                <span class="text-sm text-gray-400 font-medium" id="rate-breakdown"></span>
                            </div>
                        </div>
                        
                        <div id="loading-spinner" class="hidden text-accent mr-4">
                            <i class="fas fa-circle-notch fa-spin text-2xl"></i> Syncing...
                        </div>

                        <button type="button" id="next-btn" class="bg-accent hover:bg-cyan-400 text-white px-8 py-3 rounded-full font-bold shadow-lg transition-all transform hover:-translate-y-1 disabled-btn" disabled>
                            Next Step <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>

                </form>
            </div>
        </section>
    </main>

    <footer class="bg-slate-900 text-white py-8 text-center border-t border-slate-800">
        <div class="container mx-auto px-4">
            <p class="text-gray-400 text-sm">Need assistance? Call <a href="tel:0707643709" class="text-accent font-bold">070 764 3709</a></p>
            <p class="text-gray-600 text-xs mt-4">&copy; 2025 Ngaoyi Cleaning. All rights reserved.</p>
        </div>
    </footer>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDM4fAVuAB0X5dja_wwIxmu4abB6bTPrXk&libraries=places&callback=initAutocomplete" async defer></script>

    <script>
        // ðŸ”´ API URL
        const API_URL = 'https://script.google.com/macros/s/AKfycbycs4Rnz7UOcGtZlKc6pGEiykbCWkqO4UpwsGZU-VrM_e5Qa8oKKmG2k2fejnN43oym/exec';

        let sheetPricing = null;
        let fpInstance = null;
        let requiredDates = 1;
        let isAddressValid = false;

        // ALLOWED AREAS (Service Check)
        const ALLOWED_AREAS = ['Johannesburg', 'Pretoria', 'Sandton', 'Midrand', 'Centurion', 'Fourways', 'Randburg', 'Roodepoort', 'Kempton Park', 'Germiston', 'Alberton', 'Edenvale', 'Bedfordview', 'Boksburg', 'Benoni'];

        // MAPPINGS
        const serviceMap = {
            'weekly': 'Weekly Recurring',
            'biweekly': 'Bi-weekly Recurring',
            'monthly': 'Monthly Recurring',
            'once-off': 'Once-Off Cleaning',
            'deep': 'Deep Cleaning',
            'emergency': 'Emergency Service'
        };
        const sizeMap = { '1-bed': '1-Bedroom', '2-bed': '2-Bedroom', '3-bed': '3-Bedroom', '4-bed': '4-Bedroom', 'office': 'Office/Commercial' };

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', async () => {
            await fetchPrices();
            
            // Listeners
            document.getElementById('service-type').addEventListener('change', updateCalendarMode);
            document.getElementById('property-size').addEventListener('change', calculateTotal);
            document.getElementById('next-btn').addEventListener('click', saveAndNext);
            
            // Disable Enter Key on form
            document.getElementById('booking-form').addEventListener('keydown', (e) => { if(e.key === 'Enter') e.preventDefault(); });
        });

        // --- GOOGLE MAPS AUTOCOMPLETE & VERIFICATION ---
        function initAutocomplete() {
            const input = document.getElementById("address");
            if (!input) return;

            const options = {
                componentRestrictions: { country: "za" }, // Restrict to South Africa
                fields: ["formatted_address", "address_components", "geometry"],
                types: ["address"]
            };

            const autocomplete = new google.maps.places.Autocomplete(input, options);

            autocomplete.addListener("place_changed", () => {
                const place = autocomplete.getPlace();
                const errorMsg = document.getElementById('address-error');
                const successMsg = document.getElementById('address-success');

                // 1. Check if valid Google place
                if (!place.geometry) {
                    input.classList.add('border-red-500');
                    errorMsg.textContent = "Please select a valid address from the list.";
                    errorMsg.classList.remove('hidden');
                    successMsg.classList.add('hidden');
                    isAddressValid = false;
                    validateForm();
                    return;
                }

                // 2. Check Area (Geofencing via Text Match)
                let areaFound = false;
                const fullAddress = place.formatted_address || "";
                
                if (place.address_components) {
                    for (const component of place.address_components) {
                        const name = component.long_name;
                        if (ALLOWED_AREAS.some(area => name.includes(area))) {
                            areaFound = true;
                            break;
                        }
                    }
                }

                if (!areaFound) {
                    if (ALLOWED_AREAS.some(area => fullAddress.includes(area))) areaFound = true;
                }

                if (areaFound) {
                    input.value = fullAddress;
                    input.classList.remove('border-red-500');
                    input.classList.add('border-green-500');
                    errorMsg.classList.add('hidden');
                    successMsg.classList.remove('hidden');
                    isAddressValid = true;
                } else {
                    input.classList.add('border-red-500');
                    input.classList.remove('border-green-500');
                    errorMsg.textContent = "Sorry, we do not serve this area yet.";
                    errorMsg.classList.remove('hidden');
                    successMsg.classList.add('hidden');
                    isAddressValid = false;
                }
                validateForm();
            });
        }

        // --- PRICING ---
        async function fetchPrices() {
            document.getElementById('loading-spinner').classList.remove('hidden');
            try {
                const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'get-pricing' }) });
                const data = await res.json();
                if(data.success) {
                    sheetPricing = data.pricing;
                    console.log("Prices Loaded");
                }
            } catch(e) { console.error(e); }
            document.getElementById('loading-spinner').classList.add('hidden');
        }

        // --- CALENDAR LOGIC ---
        function updateCalendarMode() {
            const type = document.getElementById('service-type').value;
            const input = document.getElementById('calendar-input');
            const hint = document.getElementById('calendar-hint');
            const counter = document.getElementById('date-counter');

            if(!type) {
                input.disabled = true;
                input.placeholder = "Choose a plan to unlock calendar";
                if(fpInstance) fpInstance.clear();
                return;
            }

            input.disabled = false;
            input.placeholder = "Click to select dates...";
            
            let mode = 'single';
            let maxDates = 1;
            
            if (type === 'weekly') {
                mode = 'multiple'; maxDates = 4; requiredDates = 4;
                hint.innerHTML = `<i class="fas fa-exclamation-circle text-primary"></i> Please select exactly <b>4 dates</b>.`;
                counter.classList.remove('hidden');
            } else if (type === 'biweekly') {
                mode = 'multiple'; maxDates = 2; requiredDates = 2;
                hint.innerHTML = `<i class="fas fa-exclamation-circle text-primary"></i> Please select exactly <b>2 dates</b>.`;
                counter.classList.remove('hidden');
            } else {
                mode = 'single'; maxDates = 1; requiredDates = 1;
                hint.textContent = "Please select your preferred date.";
                counter.classList.add('hidden');
            }

            if(fpInstance) fpInstance.destroy();

            fpInstance = flatpickr("#calendar-input", {
                mode: mode,
                minDate: "today",
                maxDate: new Date().fp_incr(60), 
                dateFormat: "Y-m-d",
                conjunction: ", ",
                onChange: function(selectedDates) {
                    if (mode === 'multiple' && selectedDates.length > maxDates) {
                        selectedDates.pop(); 
                        this.setDate(selectedDates); 
                        alert(`Maximum ${maxDates} dates allowed for this plan.`);
                        return;
                    }
                    
                    document.getElementById('date-counter').textContent = `${selectedDates.length}/${requiredDates} Selected`;
                    
                    if (selectedDates.length === requiredDates) {
                        input.classList.add('border-green-500');
                        input.classList.remove('border-gray-300', 'border-red-500');
                    } else {
                        input.classList.remove('border-green-500');
                        if(selectedDates.length > 0) input.classList.add('border-red-500');
                    }
                    
                    calculateTotal();
                }
            });
            calculateTotal();
        }

        // --- TOTAL CALC ---
        function calculateTotal() {
            const sCode = document.getElementById('service-type').value;
            const pCode = document.getElementById('property-size').value;
            
            if(!sCode || !pCode || !sheetPricing || !fpInstance) return;

            const sName = serviceMap[sCode];
            const pName = sizeMap[pCode];
            const dates = fpInstance.selectedDates;
            const visitCount = dates.length > 0 ? dates.length : 1; 

            // Get Base Price (Per Visit)
            let perVisit = 0;
            if (sheetPricing[sName] && sheetPricing[sName][pName]) {
                perVisit = Number(sheetPricing[sName][pName].base); 
            }

            const total = perVisit * visitCount;

            document.getElementById('subtotal').textContent = `R ${total.toFixed(2)}`;
            
            let breakdownText = `R${perVisit} base x ${dates.length || 1} visit(s)`;
            
            document.getElementById('rate-breakdown').textContent = breakdownText;

            validateForm(dates.length === requiredDates, total > 0);
        }

        // --- VALIDATION ---
        function validateForm(dateValid = false, priceValid = false) {
            const name = document.getElementById('full-name').value;
            const email = document.getElementById('email').value;
            const phone = document.getElementById('phone').value;
            const btn = document.getElementById('next-btn');

            if (!dateValid && fpInstance) {
                dateValid = fpInstance.selectedDates.length === requiredDates;
            }

            if (isAddressValid && dateValid && name && email && phone) {
                btn.disabled = false;
                btn.classList.remove('disabled-btn');
            } else {
                btn.disabled = true;
                btn.classList.add('disabled-btn');
            }
        }

        // Listen for input changes to re-validate
        ['full-name', 'email', 'phone'].forEach(id => {
            document.getElementById(id).addEventListener('input', () => validateForm());
        });

        // --- SAVE ---
        function saveAndNext() {
            const dates = fpInstance.selectedDates.map(d => d.toISOString().split('T')[0]);
            
            const bookingData = {
                name: document.getElementById('full-name').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value,
                serviceType: serviceMap[document.getElementById('service-type').value],
                propertySize: sizeMap[document.getElementById('property-size').value],
                serviceCode: document.getElementById('service-type').value,
                propertySizeCode: document.getElementById('property-size').value,
                materialsOption: 'customer-supply', // Defaulted
                dates: dates,
                time: document.getElementById('time-slot').value,
                instructions: document.getElementById('instructions').value,
                baseTotal: parseFloat(document.getElementById('subtotal').textContent.replace('R ',''))
            };

            localStorage.setItem('bookingData', JSON.stringify(bookingData));
            window.location.href = 'booking-addons.html';
        }
    </script>
</body>
</html>
