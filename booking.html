<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Cleaning Service | Ngaoyi Cleaning</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#003b6f',
                        'accent': '#00c6ff'
                    },
                    fontFamily: { 'sans': ['Segoe UI', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        .flatpickr-day.selected { background: #003b6f !important; border-color: #003b6f !important; }
        .disabled-btn { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body class="font-sans text-gray-700 bg-white">
    
    <header class="sticky top-0 z-40 bg-white shadow-md">
        <nav class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <img src="https://raw.githubusercontent.com/ngaoyicleaning/ngaoyicleaning/main/assets/logo.png" class="w-10 h-10">
                <h1 class="text-2xl font-bold text-primary">Ngaoyi Cleaning</h1>
            </div>
            <div class="hidden md:flex space-x-6">
                <a href="index.html" class="hover:text-primary">Home</a>
                <a href="services.html" class="hover:text-primary">Services</a>
                <a href="pricing.html" class="hover:text-primary">Pricing</a>
            </div>
        </nav>
    </header>

    <main class="py-8">
        <div class="container mx-auto px-4 mb-8">
            <div class="flex justify-center items-center text-sm font-bold text-gray-400">
                <span class="text-primary">1. Details</span>
                <span class="mx-4 text-gray-300">----------</span>
                <span>2. Add-ons</span>
                <span class="mx-4 text-gray-300">----------</span>
                <span>3. Pay</span>
            </div>
        </div>

        <section class="container mx-auto px-4 max-w-4xl">
            <form id="booking-form" class="bg-white rounded-xl shadow-lg p-6 md:p-8">
                
                <h2 class="text-xl font-bold text-primary mb-4 border-b pb-2">1. Contact Details</h2>
                <div class="grid md:grid-cols-2 gap-6 mb-8">
                    <div><label class="block mb-1 font-semibold">Full Name *</label><input type="text" id="full-name" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-primary outline-none"></div>
                    <div><label class="block mb-1 font-semibold">Email *</label><input type="email" id="email" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-primary outline-none"></div>
                    <div><label class="block mb-1 font-semibold">Phone *</label><input type="tel" id="phone" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-primary outline-none"></div>
                    <div><label class="block mb-1 font-semibold">Address *</label><input type="text" id="address" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-primary outline-none" placeholder="Street & Area"></div>
                </div>

                <h2 class="text-xl font-bold text-primary mb-4 border-b pb-2">2. Service Selection</h2>
                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block mb-1 font-semibold">Plan *</label>
                        <select id="service-type" class="w-full p-3 border rounded-lg bg-white">
                            <option value="">-- Select Plan --</option>
                            <option value="weekly">Weekly Recurring (4 Dates)</option>
                            <option value="biweekly">Bi-weekly Recurring (2 Dates)</option>
                            <option value="monthly">Monthly Recurring (1 Date)</option>
                            <option value="once-off">Once-Off Cleaning</option>
                            <option value="deep">Deep Cleaning</option>
                            <option value="emergency">Emergency Service</option>
                        </select>
                    </div>
                    <div>
                        <label class="block mb-1 font-semibold">Size *</label>
                        <select id="property-size" class="w-full p-3 border rounded-lg bg-white">
                            <option value="">-- Select Size --</option>
                            <option value="1-bed">1-Bedroom</option>
                            <option value="2-bed">2-Bedroom</option>
                            <option value="3-bed">3-Bedroom</option>
                            <option value="4-bed">4-Bedroom</option>
                            <option value="office">Office/Commercial</option>
                        </select>
                    </div>
                </div>

                <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-100">
                    <div class="flex justify-between mb-2">
                        <label class="font-bold text-primary">Select Date(s) *</label>
                        <span id="date-counter" class="text-xs font-bold text-primary bg-white px-2 py-1 rounded shadow hidden">0 selected</span>
                    </div>
                    
                    <input type="text" id="calendar-input" class="w-full p-3 border rounded-lg bg-white cursor-pointer" placeholder="Select Service first..." disabled>
                    <p id="calendar-hint" class="text-xs text-gray-500 mt-2">Select a plan to enable the calendar.</p>
                </div>

                <div class="mb-8">
                    <label class="block mb-1 font-semibold">Time *</label>
                    <select id="time-slot" class="w-full p-3 border rounded-lg bg-white">
                        <option value="08:00">08:00</option><option value="09:00">09:00</option><option value="10:00">10:00</option>
                        <option value="11:00">11:00</option><option value="12:00">12:00</option><option value="13:00">13:00</option>
                    </select>
                </div>

                <div class="bg-gray-900 text-white p-6 rounded-xl mb-8 flex justify-between items-center">
                    <div>
                        <p class="text-gray-400 text-sm">Estimated Total</p>
                        <h3 class="text-2xl font-bold" id="subtotal">R 0.00</h3>
                        <p class="text-xs text-gray-500" id="rate-breakdown">Rate: R0 x 0 visits</p>
                    </div>
                    <div id="loading-spinner" class="hidden text-accent"><i class="fas fa-circle-notch fa-spin text-2xl"></i></div>
                </div>

                <div class="flex justify-end">
                    <button type="button" id="next-btn" class="bg-accent hover:bg-blue-400 text-white px-8 py-3 rounded-full font-bold shadow-lg transition-all disabled-btn" disabled>
                        Next Step <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </form>
        </section>
    </main>

    <footer class="bg-black text-white py-8 text-center">
        <p>&copy; 2024 Ngaoyi Cleaning. <a href="tel:0707643709" class="text-accent">070 764 3709</a></p>
    </footer>

    <script>
        // ðŸ”´ API CONFIGURATION
        const API_URL = 'https://script.google.com/macros/s/AKfycbzQZo_rLSS86ZwuioQzdQek621SZh5vlrphB94Kql2nFVu5o_X7-p2lFr4UEHku_zgSqw/exec';

        let sheetPricing = null;
        let fpInstance = null;
        let requiredDates = 1;

        // MAPPINGS
        const serviceMap = {
            'weekly': 'Weekly Recurring',
            'biweekly': 'Bi-weekly Recurring',
            'monthly': 'Monthly Recurring',
            'once-off': 'Once-Off Cleaning',
            'deep': 'Deep Cleaning',
            'emergency': 'Emergency Service'
        };
        const sizeMap = { '1-bed': '1-Bedroom', '2-bed': '2-Bedroom', '3-bed': '3-Bedroom', '4-bed': '4-Bedroom', 'office': 'Office/Commercial' };

        document.addEventListener('DOMContentLoaded', async () => {
            await fetchPrices();
            
            // Listeners
            document.getElementById('service-type').addEventListener('change', updateCalendarMode);
            document.getElementById('property-size').addEventListener('change', calculateTotal);
            document.getElementById('next-btn').addEventListener('click', saveAndNext);
        });

        // 1. FETCH PRICES
        async function fetchPrices() {
            document.getElementById('loading-spinner').classList.remove('hidden');
            try {
                const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'get-pricing' }) });
                const data = await res.json();
                if(data.success) {
                    sheetPricing = data.pricing;
                    console.log("Prices Loaded");
                }
            } catch(e) { console.error(e); }
            document.getElementById('loading-spinner').classList.add('hidden');
        }

        // 2. SMART CALENDAR LOGIC
        function updateCalendarMode() {
            const type = document.getElementById('service-type').value;
            const input = document.getElementById('calendar-input');
            const hint = document.getElementById('calendar-hint');
            const counter = document.getElementById('date-counter');

            if(!type) {
                input.disabled = true;
                if(fpInstance) fpInstance.clear();
                return;
            }

            input.disabled = false;
            
            // Define Rules
            let mode = 'single';
            let maxDates = 1;
            
            if (type === 'weekly') {
                mode = 'multiple';
                maxDates = 4;
                requiredDates = 4;
                hint.textContent = "Please select exactly 4 dates within the next month.";
                counter.classList.remove('hidden');
            } else if (type === 'biweekly') {
                mode = 'multiple';
                maxDates = 2;
                requiredDates = 2;
                hint.textContent = "Please select exactly 2 dates within the next month.";
                counter.classList.remove('hidden');
            } else {
                // Monthly, Once-Off, Deep, Emergency -> Single Date
                mode = 'single';
                maxDates = 1;
                requiredDates = 1;
                hint.textContent = "Please select your preferred service date.";
                counter.classList.add('hidden');
            }

            // Destroy old instance to change mode
            if(fpInstance) fpInstance.destroy();

            // Init New Flatpickr
            fpInstance = flatpickr("#calendar-input", {
                mode: mode,
                minDate: "today",
                maxDate: new Date().fp_incr(30), // Limit to 1 month from today
                dateFormat: "Y-m-d",
                conjunction: ", ",
                maxDate: new Date().fp_incr(31), // Limit to 31 days ahead
                onChange: function(selectedDates) {
                    // Enforce Limits manually for cleaner UI interaction
                    if (mode === 'multiple' && selectedDates.length > maxDates) {
                        this.clear(); // Or remove last
                        alert(`You can only select ${maxDates} dates for this plan.`);
                        return;
                    }
                    
                    // Update UI
                    document.getElementById('date-counter').textContent = `${selectedDates.length}/${requiredDates} selected`;
                    calculateTotal();
                    
                    // Validate
                    if (selectedDates.length === requiredDates) {
                        input.style.borderColor = '#10b981'; // Green
                    } else {
                        input.style.borderColor = '#ef4444'; // Red
                    }
                }
            });
        }

        // 3. CALCULATE TOTAL
        function calculateTotal() {
            const sCode = document.getElementById('service-type').value;
            const pCode = document.getElementById('property-size').value;
            
            if(!sCode || !pCode || !sheetPricing || !fpInstance) return;

            const sName = serviceMap[sCode];
            const pName = sizeMap[pCode];
            const dates = fpInstance.selectedDates;

            // Get Base Price (Per Visit)
            let perVisit = 0;
            if (sheetPricing[sName] && sheetPricing[sName][pName]) {
                perVisit = Number(sheetPricing[sName][pName].base); 
            }

            // Emergency Multiplier
            if (sCode === 'emergency') perVisit = perVisit; // Logic handled in backend usually, or apply here: perVisit * 1.5

            const total = perVisit * dates.length;

            document.getElementById('subtotal').textContent = `R ${total.toFixed(2)}`;
            document.getElementById('rate-breakdown').textContent = `Rate: R${perVisit} x ${dates.length} visit(s)`;

            // Enable Button
            const btn = document.getElementById('next-btn');
            const validDates = dates.length === requiredDates;
            const validInfo = document.getElementById('full-name').value !== "";

            if (validDates && total > 0 && validInfo) {
                btn.disabled = false;
                btn.classList.remove('disabled-btn');
            } else {
                btn.disabled = true;
                btn.classList.add('disabled-btn');
            }
        }

        // 4. SAVE & NEXT
        function saveAndNext() {
            const requiredIds = ['full-name', 'email', 'phone', 'address'];
            for(let id of requiredIds) {
                if(!document.getElementById(id).value) { alert("Please fill in all contact fields."); return; }
            }

            const dates = fpInstance.selectedDates.map(d => d.toISOString().split('T')[0]);
            
            const bookingData = {
                name: document.getElementById('full-name').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value,
                serviceType: serviceMap[document.getElementById('service-type').value],
                propertySize: sizeMap[document.getElementById('property-size').value],
                serviceCode: document.getElementById('service-type').value,
                propertySizeCode: document.getElementById('property-size').value,
                dates: dates, // Array
                time: document.getElementById('time-slot').value,
                baseTotal: parseFloat(document.getElementById('subtotal').textContent.replace('R ',''))
            };

            localStorage.setItem('bookingData', JSON.stringify(bookingData));
            window.location.href = 'booking-addons.html';
        }
    </script>
</body>
</html>
